{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container p-4">
    <h3>Assign Programs</h3>

    <form method="post" id="assignment-form">
        {% csrf_token %}

        <label>Team</label>
        <select id="team-select" name="team" class="form-select">
            <option value="">-- Select Team --</option>
            {% for team in teams %}
                <option value="{{ team.id }}">{{ team.name }}</option>
            {% endfor %}
        </select>

        <label>Category</label>
        <select id="category-select" name="category" class="form-select">
            <option value="">-- Select Category --</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
        </select>

        <label>Contestant</label>
        <select id="contestant-select" name="contestant" class="form-select">
            <option value="">-- Select Contestant --</option>
        </select>

        <div id="program-list" class="mt-3"></div>

        <button type="submit" class="btn btn-success mt-3">Assign</button>
    </form>
</div>

<script>
document.getElementById('contestant-select').addEventListener('change', function() {
    let contestantId = this.value;
    let categoryId = document.getElementById('category-select').value;

    if (contestantId && categoryId) {
        fetch(`/get-programs/?contestant_id=${contestantId}&category_id=${categoryId}`)
            .then(response => response.json())
            .then(data => {
                let programListDiv = document.getElementById('program-list');
                programListDiv.innerHTML = '';

                if (data.programs.length > 0) {
                    data.programs.forEach(prog => {
                        programListDiv.innerHTML += `
                            <div>
                                <input type="checkbox" name="programs" value="${prog.id}" class="program-checkbox">
                                ${prog.name}
                            </div>`;
                    });

                    // Add max 5 validation
                    document.querySelectorAll('.program-checkbox').forEach(cb => {
                        cb.addEventListener('change', function() {
                            let checked = document.querySelectorAll('.program-checkbox:checked');
                            if (checked.length > 5) {
                                alert('You can only select up to 5 programs!');
                                this.checked = false;
                            }
                        });
                    });

                } else {
                    programListDiv.innerHTML = '<p>No programs available.</p>';
                }
            });
    }
});
document.getElementById('category-select').addEventListener('change', function() {
    let teamId = document.getElementById('team-select').value;
    let categoryId = this.value;

    if (teamId && categoryId) {
        fetch(`/get-contestants/?team_id=${teamId}&category_id=${categoryId}`)
            .then(response => response.json())
            .then(data => {
                let contestantSelect = document.getElementById('contestant-select');
                contestantSelect.innerHTML = '<option value="">-- Select Contestant --</option>';
                data.contestants.forEach(c => {
                    contestantSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                });
            });
    }
});
</script>
{% endblock %}
